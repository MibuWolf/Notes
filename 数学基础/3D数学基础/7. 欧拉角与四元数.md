---
tags:
  - maths
---

# 1. 常用的空间旋转表示方式

在图形学中常见的旋转表示方式有：矩阵，极坐标，欧拉角，轴角，四元数。矩阵和极坐标之前已经有所论述在此不再赘述，轴角是指使用旋转轴和旋转角度宝表示旋转的方式$(v,α)$表示绕向量$v$旋转$α$度的旋转信息。但这种轴角的方式与欧拉角类似存在奇异点的问题eg：角度为$0$是$v$为任意轴结果都一样。

# 2. 欧拉角

欧拉角就是物体绕坐标系三个坐标轴（x， y， z轴）的旋转角度，在这里坐标系可以是世界坐标系，也可以是物体坐标系，旋转顺序也是任意的。(最常见的是使用Roll-Pitch-Yaw(或者x-y-z)三个自身轴表示旋转角度)

![[Pic_032.png]]

# 3. 欧拉角表示旋转的利与弊

- 优点1:  欧拉角表示旋转的最大好处就是直观，一眼看去就可以清楚知道绕x,y,z轴的旋转角度。
- 缺点1: 旋转结果与执行顺序有关，同样(90,90,90)如果按照x,y,z轴顺序旋转（各旋转90度）和按照z,y,x轴顺序旋转(各旋转90度)的结果是不同的 (可以自己用手机实验下)
- 缺点2:  存在万向节死锁的问题。

# 4. 欧拉角的万向节死锁

## 4.1 万向节死锁的原因

由矩阵笔记可知三维向量可以表示三个空间的前提是三个轴向均不共线，如果两个轴向共线则只能描述一个平面，如果三个轴向都共线，描述的则是一个直线，万向节死锁的本质是沿着第二旋转轴旋转90°时导致第一旋转轴和第三旋转轴共线导致无法描述三维空间角度。

## 4.2 万向节死锁的理解

以上说法比较抽象，举个实际的例子有助于理解什么叫万向节死锁。将手机平放在桌面上屏幕向上（定义垂直屏幕的方向为z轴），手机短的边为x轴，长的边为y轴。先绕手机第一旋转轴向(z轴)旋转任意角度(eg:30°)，再绕手机的第二旋转轴向(x轴)旋转90°，当你在绕第三轴向(y轴)旋转时你会发现此时旋转的方向与绕自身z轴旋转时一样都是绕垂直于桌面的方向转动。而手机的最终形态永远会垂直于桌面（无论你先绕z轴转多少度最终再绕y轴绕多少度结果永远是手机垂直于桌面）。当然如果第二次旋转轴向不为90°，根据自身z轴和自身y轴的不同旋转角度，手机的最终形态是可以在三维空间内任意旋转的，这种现象就是万向节死锁。

# 5. 四元数

## 5.1 四元数的定义

四元数被定义为表示$3D$空间旋转的一种方式，它有一个三维向量$v$和一个标量组成,  如: $q = (v,w)$四元数的形态有些类似于轴角的表示方式，但与轴角的含义完全不同： $p = (v,w) = (sin(α/2)*n,cos(α/2))$  $α$为旋转角度，$n$ 为旋转轴的单位向量。

## 5.2 四元数计算

- 四元数取反:  四元数$q = (v,w)$  对四元数取反 $-q = (-v,-w$),此时$q$与$-q$表示的旋转角度相同。这可能很难理解，试想下对任意轴旋转$α°$和对此轴旋转$α+360°$的结果就是对其取反因为$sin(α/2) cos(α/2)$与$sin((α+360)/2)$ $cos((α+360)/2)$的值正好大小相等符号相反。
- 单位四元数:  $q = ((0,0,0),1)$  $q = ((0,0,0),-1)$为两个单位四元数表示的旋转$0°$。
- 四元数的模： $|q|$ = $sqrt(x*x+y*yyy+z*z+w*w) = sqrt(cos(α/2)^2 + (sin(α/2)n)^2)$ 如果旋转轴$n$是单位向量则 $|q| = 1 (cos^2+sin^2=1)$
- 共轭四元数：共轭四元数定义为 : $q* = (-v，w) = (-x, -y, -z, w)$ 即： 共轭四元数是将原四元数标量部分不变，向量部分取反得出的。
- 四元数的逆：四元数的逆定义为$q^-1$,其具体计算为:  $q^-1 = q*/|q|$ 当旋转轴$n$为单位向量时   $|q|=1$, 也就是说  $q^-1 = q*$ 。四元数的逆与实数有着类似的性质即 $q*q^-1 = I = (0,0,0,1)$。
- 四元数与四元数的逆： 当旋转轴n为单位向量时，$q-1= q* =(-v,w)$ 由此可见四元数的逆和四元数本身的旋转方向相反旋转角度一致。(eg: 绕$x$轴旋转45°与绕$-x$轴旋转45°的旋转方向正好相反但都旋转45°)其结果与旋转轴不变旋转角度取反$(v,-w)$从结果上看是一致的。
- 四元数的乘法：两个四元数相乘结果仍然是四元数： $q1*q2 = ((x1,y1,z1),w1) = (w1v2 + w2v1 + v1 * v2, w1w2 - v1.v2)$
   四元数乘法不满足交换律但是满足结合律:    $(a*b)*c = a * (b * c)$    
   $a*b ≠ b * a$
 - 四元数积的模等于四元数模的积 $|q1*q2| = |q1| * |q2|$
 - 四元数积的逆：  $(q1*q2)^-1=q2^-1*q1^-1$。
 - 坐标绕四元数旋转： 旋转后坐标 $p1 = q*p*q^-1$ 连续对多个轴进行旋转时$p2 = Q*p1*Q^-1 = Q*q*p*q^-1*Q^-1$ 因此可以推断出四元数$r = Q*q$表示先按$q$旋转在按$Q$旋转，这个顺序与矩阵的计算顺序不同。由这个结论可以推论四元数$r$和四元数$q$之间的夹角(或者说q经过什么样的旋转可以             达到$r$) 由于$r = Q*q=> r*q-1 = Q$也就是说四元数$q$经过 $r*q^-1$的旋转之后可以到达r的描述角度。
 - 四元数点乘:  $q1 . q2 = (v1,w1) . (v2,w2) = x1x2 + y1y2 + z1z2 + w1w2;$ 如果q1 q2都是单位四元数则：$-1 <= q1.q2 <= 1$。其几何含义是$q1.q2$表示的是两个四元数夹角的$cos$值，也就是说$cosα = q1.q2$，$α$为两个四元数夹角的角度。

# 6. 四元数的差值

## 6.1 四元数线性差值

线性差值计算较为简单，与一般线性计算类似： $lerp(q0,q1,t) = ((1-t)q0 + tq1)/|(1-t)q0+tq1|$

## 6.2 四元数球面差值

![[Pic_033.png]]

我们的目标是经过球面差值算出中键的$vt$($v0,v1$均为单位向量)，我们将其视为向量则一定存在 $vt = k0*v0 + k1 * v1$。 由上图及几何知识可知 s$inw = sintw / k1$，    $k1 = sintw / sinw$。 同样的防范可以求得$k0: k0 = sin(1-t)w / sinw=>vt = k0*v0 + k1v1 =>vt = (sin(1-t)w / sinw)* vo+ (sintw/sinw)*v1$   扩展到四元数可以得出四元数球面差值的公式为：         slerp(q0,q1,t) = (sin(1-t)w/sinw)*q0+(sintw/sinw)*q1。

# 7. 总结

- 四元数本身表示的含义是$nsin(α/2) +cos(α/2)n$为旋转轴 $α$为旋转角度
- 四元数与四元数的逆 $q = (v,n)$    $-q = (-v,-n)$表示的旋转时相同的
- 如果旋转轴n是单位向量则四元数的逆与其共轭四元数是相同的 $q* = q-1$
- 点$p$绕四元数$q$旋转后的新坐标点 $p1 = qpq-1$
- 绕多个四元数连续旋转  $qn = q3*q2*q1$表示先绕$q1$旋转再绕$q2$旋转再绕$q3$旋转
- 两个四元数点乘的结果是其夹角的$cos$值  $q1 . q2 = cosα$
- 四元数线性差值 $lerp(q0,q1,t) = ((1-t)q0 + tq1)/|(1-t)q0+tq1|$
- 四元数球面差值$slerp(q0,q1,t) = (sin(1-t)w/sinw)*q0+(sintw/sinw)*q1$
- 具体四元数 矩阵 欧拉角的转换公式用的时候直接google