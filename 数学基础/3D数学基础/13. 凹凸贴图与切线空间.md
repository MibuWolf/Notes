---
tags:
  - maths texture
---

# 1. 凹凸贴图(Bump Mapping)

## 1.1 凹凸贴图

贴图在图形学中应用最多最的应该是表达物体表面颜色(如: diffuseTex)除此之外就是用于表面凹凸感的凹凸贴图。凹凸贴图的形式用很多，例如存储表面高度的高度图，或者存储表面法线信息的法线贴图，亦或者是视差贴图。由于光照计算中使用的是法线信息，高度图，视差贴图都需要额外计算出法线信息，因此法线贴图是目前图形学中使用最多的表达凹凸感的贴图。

## 1.2 法线贴图

在法线贴图中每个像素存储的都是表面的法线信息，归一化的法线方向(x,y,z)被映射到贴图中的(r,g,b)，由于法线法相可正可负因此法线x,y,z的取值范围是(-1,1)但r,g,b的趋势范围是(0,1)所以在Shader中采样出法线像素后要先转换到法线坐标的趋势范围。法线贴图一般有美术人员在3DMax等工具中从高模塌陷到低模(真正使用的模型)烘焙出法线贴图。

# 1.3 切线空间(Tangent Space)

对于法线贴图当前最通用的做法是将切线空间下的法线信息保存到法线贴图中。在切线空间中z轴正方向垂直于表面本身,也就是表面法线方向用向量n表示。x轴为切线方向用向量u表示，y轴为副切线方向用向量v表示，所谓切线方向就是指向纹理空间的u方向，副切线方向对应纹理空间的v方向。也就是说在切线空间，沿x轴移动相当于在沿着物体贴图坐标的u方向移动。(例如; 我们从法线贴图采样出颜色数据为(37,128,218)将其转换为归一化法线坐标为(-0.701,0,0.707)该坐标是切线空间坐标)

## 1.4 切线空间到模型空间的矩阵

由于顶点光照等信息需要从模型空间开始进行空间转化，因此我们第一步需要做的便是将切线空间的法线坐标转化到模型空间。由矩阵的定义用模型空间的切线方向副切线方向和法线方向作为坐标轴可以构建切线空间到模型空间的转换矩阵如下：

![[Pic_068.png]]

## 1.5 光照到切线空间去计算

![[Pic_069.png]]

为什么要把光照计算移到切线空间去做计算呢？本质原因是因为在切线空间计算的效率比在模型或者其他空间更高。在切线空间性能更高的原因跟我一起慢慢分析。如上图假设模型表面被挤压(或拉伸)根据左侧部分uv坐标该平面内任意一点的uv坐标的轴向都需要根据顶点做差值计算(右侧图中任意一点的uv坐标轴方向都是一致的)这样说可能不容易理解举个例子，假设分别在左右两个面$(1/4.1/4)$位置采样右边的纹理坐标一定是$(0.25,0.25)$该坐标方向仍然是x代表水平方向y代表垂直方向，但左侧的纹理坐标变成了$(0.167,0.25)$在UV坐标系来看此时v轴已经不是垂直方向了。因此此时如果需要将法线从切线空间变化到模型空间在片元着色器中就不得不逐像素的重新计算uv方向及重新构建切线空间矩阵(必须逐像素计算，因为每个像素的uv轴向都不同在顶点级别计算没有意义)消耗较大。如果将光照计算所需的l(光找向量)和h(半向量)在顶点着色时传入切线空间，然后在光栅化时在切线空间对其进行差值计算这样的效率更高。要从模型空间转化到切线空间只需将切线空间矩阵求逆即可。正交矩阵(各轴向相互垂直并且为单位向量)的逆矩阵等于其转置矩阵。由挤压可知uv不一定全程垂直也就是说切线矩阵在面上任一点不一定严格正交，但所幸我们当做正交矩阵计算通常并不会造成任何问题，因此一般用切线的转置矩阵作为模型到切线空间的变换矩阵。

## 1.6 计算切线空间的矩阵的基向量

之前有讲过构建切线空间到模型空间的矩阵本质上是定义新空间下的基向量，模型空间的法线已知，最终要的是计算切向量和副的切向量的两个轴向的基向量。对于一个三角面我们已知三个顶点和三个uv坐标分别$p0~p2 u0~u2  v0~v2$。任意两个边的向量为

![[Pic_070.png]]

假设切线方向基向量为u副切线方向基向量为v则有：

![[Pic_071.png]]

对u向量v向量单位化除以常量部分得出：

![[Pic_072.png]]

这样算出来的切线副切线是针对三角形面的，与之前法线的计算类似，相邻面的切线之和作为顶点的切线方向。
以下是在顶点层面计算切线基坐标的代码：

![[Pic_073.png]]
![[Pic_074.png]]

# 2. 总结

- 凹凸贴图中最常用的是法线贴图
- 切线空间的z轴是法线方向x轴是切线方向(对应贴图空间U的方向)，y轴是副切线方向(对应贴图空间V的方向)
- 法线贴图中存储的法线方向是以切线空间的向量
- 通常并不会讲法线转化到模型空间之后进行光照计算反而是将光线方向，半向量方向转化到切线空间进行光照计算。原因是因为UV会影响切线方向的XY轴基向量，在片元着色器中计算光照及不得不逐像素重新计算切线空间矩阵开销大。如果在顶点空间将影响光照的向量转入切线空间在片元着色器中对这些向量在切线空间差值则代价小的多。
- 关于三角形面的切线副切线基向量的计算切线基向量$u = t2q1 - t1q2$ 副切线基向量$v= s1q2 - s2q1$关于某一顶点的切线基向量则可以用相邻所有面的切线向量之和表示