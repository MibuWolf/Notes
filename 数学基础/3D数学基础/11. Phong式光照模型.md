
---
tags:
  - maths lighting illumination
---

# 标准光照（Phong）模型

## 光照模型概述

在渲染方程中BRDF描述了在可见表面光的散射分布情况。其中用到积分并要采集所有可能反射到表面的光线信息，在实时渲染中并不实际(开销巨大)，大多数情况下在通过对BRDF的模拟或者简化来计算光照，而模拟简化后的光照计算公式就称为光照模型。本章介绍的主体是标准光照模型，尽管在现实使用中已经不是最新技术，但仍然是学习光照的很好的切入点。

## 标准光照模型概述

标准光照模型(Phong式光照模型)是对渲染方程(参见光照概述)做了简化模拟：保留自发光部分$cemis$, 将渲染方程中的积分部分简化为三种光照来源分别为: 镜面反射部分$cspec$，漫反射部分$cdiff$，和环境光部分$camb$。因此在标准光照模型里渲染方程就被简化成了:  $Lout(x,ωˆout, λ) = Lcemis((x,ωˆout, λ) + Lspec((x,ωˆout, λ) + Ldiff((x,ωˆout, λ) + Lamb((x,ωˆout, λ$)。 接下来会逐一介绍每部分的计算方式。

# 标准光照模型中的镜面反射(Spec)

## 镜面反射部分光照概述

镜面反射部分的光照反应的是可见表面的光泽程度，表面越光滑镜面反射的辐射量越大相反越粗糙则漫反射的辐射量越大。

## 镜面反射部分所需的数据

在考虑镜面反射部分计算时影响镜面反射辐射量的因素如下图:

![[Pic_043.png]]

其中$n$是表面法线，$v$是相机方向，$l$是光照方向，$r$是反射方向，$θ$是观察向量与反射向量的夹角。假设以上向量均为单位向量，根据下图：

![[Pic_044.png]]

根据上图辅助线可以计算出反射向量 : $r = 2(n.l)n - l$
以上提到的数据只是直观上感觉会影响光照反射量的因素，实际除此之外还有表面材质也会影响光照反射的辐射度。

## 镜面反射最终颜色计算

在标准光照(Phong)模型中，对镜面反射后的颜色计算简化为以下公式：

![[Pic_045.png]]

$Cspec$为最终颜色，$Sspec$为光照的镜面反射颜色，$Mspec$为材质中的镜面反射颜色，⊗表示颜色分量分别相乘，$Mgls$表示表面光泽度。由以上公式可知光泽度越大$v.r$不变的情况下其反射出来的光的辐射度越小，反过来说要保持同样大小的辐射度v和r向量就要越靠近，此时反射出来的光斑越小越集中。光泽度越小光斑范围越大越分散也越接近漫反射。下图明显明显的展示出光泽度和材质中的反射值对效果的影响：

![[Pic_046.png]]

## Blinn-Phong光照模式的改进

Blinn-Phong光照模式是对Pong式光照模式的改进，其基于的出发点有两个：1. 标准光照模型如果v和l在发现的同一侧则可能发生$v$和$r$的夹角大于90°的情况导致$r.l<0$从而使得光照被截断或者过度不自然 2. 当观察者距离相对于物体较大时可以将v近似当做不变的常(光照方向一般也不会发生变化因此无需每帧计算)。   为了解决问题1，Blinn-Phong光照模型舍弃使用反射向量$r$，进而引入半向量$h$(是对$v$和$l$求平均然后对其归一化)代替反射向量$r$。

![[Pic_047.png]]

Bilin-Phong光照模式下反射部分计算公式如下：

![[Pic_048.png]]

# 标准光照模型中的漫反射(Diffuse)

漫反射部分光照模拟的是粗糙表面对射入光线沿各个方向随机反射部分光的辐射度。由于是随机反射我们可以认为向各个方向反射的量是相同的，也就是说漫反射任意方向的BRDF的值都是相同的(在标准光照模型中可以简化为跟材质有关的参数)，回想下渲染方程在任何一个方向(我们关心的是相机方向)的光辐射量计算公式为：

![[Pic_049.png]]

$Lin(x,ωˆin, λ)$表示在$x$位置入射角度为$ωˆin$颜色为$λ$的光辐射量，在标准光照模型组的漫反射中简化为漫反射照$Sdiff$，$BRDF$函数在漫反射中可以简化为跟材质相关的参数$Mdiff$此时标准光照模型中漫反射部分光照计算方程就简化成了：

![[Pic_050.png]]

# 标准光照模型中的漫反射(Diffuse)

## 环境光部分光照

镜面反射和漫反射模拟的都是光线射到可见表面后反射进入相机的过程，整个过程仅在可见表面发生过一次反射，但真实世界中光子可能在相同/不同物体之间经过多次反射后才进入眼睛(相机)，而对这 部分光照的模拟就是环境光，计算公式如下：

![[Pic_051.png]]

$Mamb$是材质的光环境光颜色(一般与漫反射颜色相同)。$Gamb$是环境光值，一般是个全局变量用于整个场景。(但某些技术如光照探针可能提供额外的带方向的环境光)

## 自发光部分光照

自发光用于模拟部分发光体(如：灯泡)自身发出的光线直接入射眼睛的光照。自发光仅仅描述的是表面自身并不会影响其他物体表面，也就是说自发光并非真正的光源。因此自发光仅仅和表面材质本身有关：

![[Pic_052.png]]

# 标准光照模型中的光照方程

前面介绍了编制光照模型中模拟的各个光照分量的计算方法，对于单一光源的光照方程是以上四个光照分量之和：

![[Pic_053.png]]

多数情况下物体表面并无自发光，下图为各部分光照单独计算的效果：

![[Pic_054.png]]

多光源叠加下，由于环境光和自发光与光源本身无关因此多光源叠加公式如下:

![[Pic_055.png]]

# 标准光照模型的限制

我们所介绍的标转光照模型其实就是Blinn-Phong式光照模型，该光照模型并非完美的，例如一些物理特效的效果(如菲涅尔现象)它并不能很好的模拟，但以该光照模型作为学习光照模型的切入点是因为其他光照模型中有很多也与之类似的概念和理念方便学习其他光照模型。

# 光照与Shading

## Shading概述

Shading中最常用的两个Shader是VertexShader和FragmentShader多数情况下在VertexShader中进行顶点转换等操作在FragmentShader中将顶点颜色光栅化到像素。使用光照计算模型对可见表面进行绘制，根据光照计算对象及光栅化的方式不同可以分为三种方式分别为：Flat Shading , Gouraud Shading, Pong Shading。

## Flat vs Gouraud vs Pong Shading

**FlatShading**是针对每个三角面的法线进行光照计算，并将计算结果应用到整个三角面，除软件渲染外几乎从未使用过该方案。                          **GouraudShading**又被称为VertexLighting是在顶点级别进行光照计算，在通过线性插值的方式光栅化到三角形内所有像素点。         PongShading又被称为**FragmentLighting**是在像素级进行光照计算，对每个像素先确定表面法线(可以通过对面法线插值更多的是通过法线贴图)然后使用该表面法线进行完整的光照方程计算。      FlatShading GouraudShading PongShding三者越往后效果越好性能也越低。以下三种模式对比：

![[Pic_056.png]]

## VertexLighting下光照计算方程

如果细心就能发现标准光照模型中的光照方程并不适合GouraudShading方式(该方式是逐顶点计算发生在VertexShader中，光照方程用会用到表面材质信息，在VertexShader中无法逐像素采样)。因此需要将部分材质相关的计算放回片元着色器，需要对光照方程进行简单修改，具体如下：

![[Pic_057.png]]
![[Pic_058.png]]

由以上公式可以将光照计算方程拆为两个部分，在顶点着色器中逐顶点进行如下与法线有关的计算：

![[Pic_059.png]]

***注：法线光线等光照计算我们即可以先将所有向量转化到世界空间计算也可以全部转化到相机空间计算，甚至可以在模型空间计算，但一定要保证所有向量在同一空间，法线的空间转换矩阵与其他向量不同为$M(t)^-1$（参见之[[5. 法线从本地空间转化到视空间矩阵]]）***

在片元着色器中逐像素进行材质相关的计算：

![[Pic_060.png]]

***注： 如果材质相关的参数是定制而并非来自材质贴图则此部分计算也可以移入顶点着色器***

# 总结

- 标准光照模型将表面光照量简化为四个分布分别是：镜面反射量，漫反射量，环境光量和自发光量，其中漫反射和镜面反射是依赖具体光源的，环境光一般是全局的，自发光一般仅与材质有关。
- Blinn-Phong是对Phong式光照模型的改进，解决了相机角度与反射角度大于90°导致的高光截断的问题，使用视向量与入射光的半向量$h$来代替反射向量$r$。$Cs = Ss * Ms * (n.h)$的$gls$次方(光泽度)
- 标准Blinn-Phong光照模型使用PhongShading逐像素进行光照计算，为提升性能可以改为逐顶点计算光照方程的向量部分运算，再在片元着色器中逐像素进行材质相关计算。