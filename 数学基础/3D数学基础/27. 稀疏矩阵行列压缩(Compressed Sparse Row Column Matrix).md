---
tags:
  - maths csr csc
---
# 1. 概述

[[2. 矩阵|矩阵]]是我们经常会使用的一个数学工具，在游戏中经常会被用来表示一个空间信息等。但当我们要存储的数据很多时，这可能将会是一个巨大的数据量。例如，我们需要存储角色脸部表情的数据信息，脸部大概有600多根骨骼，利用FACS表情编码系统可以将面部表情抽象成为200多个动作单元(AU)。所有的表情又可以根据不同的AU按照不同比例组合拼装而成，当我们要记录玩家所有可能的表情数据时这将会是一个非常大量级的矩阵信息(每个矩阵用来记录一个骨骼空间信息)。此时我们就需要对所有表情数据进行压缩。

经过观察分析，我们发现对于组成脸部表情的骨骼而言其可移动范围非常有限，即：特定骨骼只能沿着很少的一个或两个方向移动/旋转(eg: 眼皮 鼻子无论做任何表情都只能上下移动)。这也就意味着虽然我们使用矩阵来承载骨骼的位置, 旋转，缩放信息，但对于表情数据而言真正需要修改的数据非常有限，因此这就为我们使用稀疏矩阵对数据进行压缩提供了可行性。

# 2. 稀疏矩阵

上述表情数据就是一个典型的稀疏矩阵案例，在开始讨论稀疏矩阵压缩前我们先来认识下什么是稀疏矩阵？

稀疏矩阵是指：矩阵中大部分元素为0(或等于某个特定值)的矩阵。稀疏度是矩阵中0或特定元素的比例。如果稀疏度高(即0或者特定元素的比例高)那么这个矩阵就可以被认为是稀疏矩阵。

我们知道，要表示三维空间中位置，旋转，缩放信息需要是一个3*4或者4*4矩阵，而上文中提到记录面部骨骼在做不同表情时很多骨骼只能沿特定的一个或两个方向移动或旋转，并且骨骼肯定不会缩放，因此对于表情信息而言其每根骨骼在特定一个表情时的空间信息大概会如下表示：

$$\begin{matrix}
1&cos(RotZ)&0&0\\
sin(RotZ)&1&0&0\\
0&0&1&0\\
0&0&PosZ&0\\
\end{matrix}$$

上述矩阵表示某骨骼在做特定表情时最大的移动旋转范围(在Z轴移动PosZ，沿Z轴旋转RotZ)。分析这个矩阵，我们很容易发现除去0和1这个矩阵中真正有效的数据只有三个：cos(RotZ)， sin(RotZ)和PosZ。这恰好符合稀疏矩阵的特征，因此我们将研究和分析如何对稀疏矩阵进行压缩。

# 3. 稀疏矩阵的压缩

# 3.1 概述

最常见的两种稀疏矩阵压缩方式是：压缩稀疏行(Compressed Sparse Row简称CRS)和压缩稀疏列( Compressed Sparse Column简称CSC)。这两种方式本质是相同的，只是针对行或者列的区别，本文将以CRS为主讨论其基本原理。

# 3.2 Compressed Sparse Row(CRS)

压缩稀疏行($CSR$)格式是一种以节省内存的方式存储稀疏矩阵的方法。它使用三个数组：`Value`, `RowIndices`和`ColumnIndices`来表示一个$m*n$矩阵$M$，其具体含义如下：

- `Value`数组：按行开始数，依次存储每一行的非零元素，其长度为矩阵中非0(非特定元素)数据的个数。
- `RowIndices`数组：每一个非零元素的列索引值，其长度为矩阵中非零(非特定元素)数据的个数。
- `ColumnIndices`数组：每一行的第一个非零元素在`Value`数组中的索引值，注意：只统计每一行第一个非零值。其总长度是其表示的$m*n$矩阵$M$行数的 $m+1$，最后多出来的一个数据为该矩阵中非零值总个数。

单纯这么说可能比较抽象，我们来考虑一个示例：

$$\begin{matrix}
1&7&0&0\\
0&2&8&0\\
5&0&3&9\\
0&6&0&4\\
\end{matrix}$$

这是一个 $4*4$ 的矩阵$M$，当我们使用$CSR$的方式对其进行压缩时，`Value` `RowIndices` `ColumnIndices`数组中的数据分别应该是什么呢？

按照`Value`数组的定义，我们按行一次存储非零数据，因此：$Value = [1,7,2,8,5,3,9,6,4]$
按照`RowIndices`数组的定义，我们采集每个非零数据的列索引存储就得到：$RowIndices = [0,1,1,2,0,2,3,1,3]$
按照`ColumnIndices`数组的定义，我们来采集每行第一个非零数据在`Value`数组的索引就得到：$ColumnIndices = [0,2,4,7,9]$

在来一个 $4*6$ 矩阵示例验证下我们的理解：

$$\begin{matrix}
10&20&0&0&0&0\\
0&30&0&40&0&0\\
0&0&50&60&70&0\\
0&0&0&0&0&80\\
\end{matrix}$$

经过$CSR$的方式对其进行压缩后可以用以下三个数组来表示这个矩阵：

$Value = [10,20,30,40,50,60,70,80]$
$RowIndices = [0,1,1,3,2,3,4,5]$
$Value = [0,2,4,7,8]$

# 3.3 Compressed Sparse Column(CRC)

压缩稀疏列($CSC$)格式与压缩稀疏行($CSR$)的基本原料是一