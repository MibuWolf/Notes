---
tags:
  - maths light illumination
---

# 1. 图形渲染是如何运作的

图形渲染的目的是通过模拟事物在自然界中的工作方式实现拟真的实时渲染。其最终目的是一张位图。现实世界中我们眼睛能看到物体是因为有光打在物体表面反射进我们的眼睛。为了模拟这一过程并最终绘制到一张位图，我们把这一过程分为两个步骤: **1. 可见表面测定   2. 光照** 而这一过程我们成为渲染算法。

# 1. 可见表面测定

## 1.1 可见表面测定

简单点来说就是确定我们能看到哪些内容，常见的方式有两种：**1. 光线追踪  2. 深度缓冲。**光线追踪的基本原理是：将每个像素转化到视空间(变成一条射线)射线射中最近的物体点为可见点。     深度缓冲的基本原理则是：对每个图元依次绘制，每个像素点记录其与相机的距离，当新绘制的距离大于现有距离时舍弃新像素否则保留新像素及距离舍弃老像素。以下为两个表面测定方式的伪代码：

![[Pic_037.png]]
![[Pic_038.png]]

## 1.2 前项渲染/延迟渲染

如上图Listing10.2中每次判断深度小于当深度时进行渲染算法的第二步骤光照计算并将结果写入颜色缓冲区的这种渲染方式被称为前项渲染。与前项渲染相对的则是延迟渲染，延迟渲染使用额外的帧缓冲区(G-Buffer)用于存储可见表面的坐标法线渲染参数等信息，以便在光照计算时使用。延迟渲染严格遵守了渲染算法的两个步骤，第一步(第一个Pass)将场景的可见表面存储在G-Buffer，第二步(第二个Pass)对每个可见表面的像素点进行光照计算。前项渲染伪代码如上图，延迟渲染如下：

![[Pic_039.png]]

***注:  延迟渲染的光照计算时针对G-Buffer，前项渲染时针对顶点，因此在大场景多光源的光照计算中延迟渲染的计算量远远小于前项渲染。***

# 2. 光照

## 2.1 光照概述

当我们说物体是什么颜色时我们常常粗略的以为这是物体本身的颜色，但实际并非如此。我们看到的物体颜色其实是物体本身吸收了其他波段的光之后反射出来的颜色。因此当我们要描述物体表面时我们需要考虑的问题是：什么颜色的光，从什么角度射向物体表面，我们从哪个方向观察物体以及物体本身表面的光泽度如何等问题为并非简单的物体本身颜色。双向反射分布函数(BRDF)就是根据以上问题抽象出来的方程，用于解决物体表面的光照计算。

## 2.2 BRDF(双向反射分布函数)

我们可以象征性的把$BRDF$写成一个函数 $f (P, Lin, Lout,Lc)$该函数的参数$p$表示物体表面点坐标，$Lin$表示光照射入方向，$Lout$表示射出方向，$Lc$ 是光的颜色。函数返回值是在反射方向的反射光强度。除$BRDF$之外影响最终颜色的因素还有物体本身的材质属性(颜色和光泽度)，使用同一个$BRDF$函数对不同和材质的物体计算是由于不同物体对不同颜色光的反射率不同(eg:绿色材质对绿色光反射率较高红色材质对红色光反射率较高)。光泽度则是会影响光线射入射出的关系，光泽度高在特定的方向会有更多的光线反射出来，光泽度低则光线更多散射在各个方向。通过对$BRDF$的扩展可以描述更复杂的现象如使用$BSSDF$(双向表面散射分布函数)表达散射现象，$BSDF$(双向散射分布函数）可以表达雾等体积效果的散射情况。

***注：BRDF本质上符合自然界的规律，如能量守恒，反射出的光的亮度必定小于等于入射光强度(有些被吸收)，反射定律互换入射反射方向得到的结果是一致的的等。***

## 2.3 光的属性

 描述光并将光参与光照计算时有两个属性非常重要一个是光的颜色一个是光的强度。真实世界中光具有波粒二象性，光波的不同频率被人眼识别为颜色，光粒子的多少会影响敏感强度。由于人眼对颜色的识别度不高，使用简单的实用RGB就可以涵盖人眼可识别的颜色范围。现实中光粒子的本质是能量与能量的单位焦耳每秒产生的能单位为焦耳一样，光强度的单位是辐射通量，表示每秒流经某个区域的光照能量总和。同样的光照能量照射在不同面积的物体表面其亮度也是不同的。因此用单位面积下的通量强度来描述光照强度更为合适，单位面积下的辐射通量被称为辐射度单位是瓦特/m。但仅用辐射度任然不能很好的描述光的"亮度", 试想在两个单位面积大小的物体表面上，用同样的辐射通量照射，第一个物体光粒子均匀从表面各个方向对其照射，第二个所有光粒子都从同一方向对其照射。非常容易可想到这两个表面的光照效果是不同的。同样的，同样方向的光照射但是表面方向一个垂直照射另一个斜着照射，最终肯定是直射的更亮。这就是兰伯特定律即：表面的角度会导致入射光线散布开来从而减少辐射度。因此在图形学中更标准的描述光照强度的单位应该是单位投影面积的辐射度(单位投影面积是就光照垂直的平面)。

# 3. 渲染方程式

以上我们了解了$BRDF$的基本概念，现在回到渲染算法第二步的光照计算来看，眼睛(相机)看到的可见表面最终结果是两部分光照计算的总和。一.   表面自发光         二.  以表面法线方向形成的半球内所有方向光线照射的总和。 以方程式的方式书写如下图：

![[3D数学基础/attachments/Pic_040.png]]

接下来我们详细解读下此方程式的含义：$x$表示表面坐标点，$ωˆout$是眼睛看的方向(光线沿$ωˆout$反射出的方向) ，$λ$表示光照颜色。$Lemis(x,ωˆout, λ)$表示的是表面自发光在$ωˆout$方向的输出。 后面积分部分比较复杂我们先简化为以下形式便于理解：

![[Pic_041.png]]

其含义是在$ωˆout$方向的光辐射总量等于所有方向入射光在$ωˆout$方向反射量的总和(积分)。单一入射方向在特定反射方向$ωˆout$的辐射度计算如下：

![[Pic_042.png]]

$Lin(x,ωˆin, λ)$表示在x位置入射角度为$ωˆin$颜色为λ的光辐射量，$f(x,ωˆin,ωˆout, λ)$为$BRDF$方程，$Lin(x,ωˆin, λ)f(x,ωˆin,ωˆout, λ)$表示计算出该辐射量入射角$ωˆin$在$ωˆout$反射方向反射出的光辐射量。$(−ωˆin · nˆ)$表示入射角与法线的夹角(兰伯特定律)。

由渲染方程可知，如果要真实的模拟光照计算除了需要知道表面位置，光的颜色，眼睛(相机)与表面方向外还需要知道所有光线(包括光照直接照射和经过空间反射到表面的光线等)在表面的入射辐射度。实际上是不现实的，主流的针对具体光源的光照计算都是对该方程的简化处理(如: 兰伯特光照)，经过其他物体反射到该表面的光照计算由全局光照进行模拟处理。

# 4. 总结

- 渲染可以简单分为两个步骤： 可见表面测定和光照计算
- 可见表面测定有两种方式:  光线追踪和深度测试
- 根据光照计算的时机将渲染流程分为： 前项渲染和延迟渲染
- BRDF是用在计算某方向光照在特定反射方向的输出辐射度的计算函数
- 除BRDF外影响表面最终颜色的因素还有表面材质，光泽度
- 总得来说相机看到的表面光照 = 自放光在相机方向辐射度 + 所有以下辐射度之和(任意角度入射光线辐射度$*BRDF()*vin*n)$