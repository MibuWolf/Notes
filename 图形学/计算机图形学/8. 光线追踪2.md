
---
tags:
  - graphics light illumination raytracing 
---

# 光线追踪中的效果

在上一章中我们介绍了光线追踪的基本原理和实现，本章将继续深入了解一些使用光线追踪构建的一些高级效果，如：折射，软阴影，景深等效果。

# 折射

## 菲涅尔定律

有菲涅尔定律我们可以知道当光从一个折射率为$n$的均匀介质向另一个折射率为$nt$的均匀介质传播时，在两者的交界处(通常称为界面)可能会同时放生反射和折射(如下图)，且反射角等于入射角，入射介质折射率乘以入射角的$Sin$值等于进入介质的折射率成语设置角的$Sin$值。即： $nSinθ = ntSinφ$。此外对光线反射量/折射量会随入射光角度不同而发生变化。(即：反射出来的光线强度和折射出来的光线强度会随入射角度不同而各自不同但其总和是相同的)

![[计算机图形学/attachments/Pic_063.png]]

## 计算折射向量

如上图在图形学计算光照时，我们可以很容易的得知表面法线向量$n$，入射光方向向量$d$，通过材质属性我们也能获取折射率$n$和$nt$.接下来我们推导下折射光线的方向向量$t$：  首先我们在交界面和入射光线所在平面构建一个二维正交基向量，其中一维是法线$n$另一维我们定义为$b$，如下图：

![[计算机图形学/attachments/Pic_064.png]]

如图可以及将入射向量 $d$ 分解到在二维正交基向量内： $d = sinθb - cosθn$   同样折射向量$t$可以拆分为：$t = sinφb - cosφn$   由这两个式子可以推导出向量$b: b = (d + cosθn) / sinθ$  将此替换上述t计算中的b向量可得：$t = sinφ(d + cosθn) / sinθ - cosφn$由菲涅尔定律 $sinφ / sinθ = n / nt$  因此： $t = n(d + cosθn) / nt - cosφn$   如果向量$d$和$n$都是单位向量则 $cosθ = -d ▪ n$ 因此 $t = n(d-n(d ▪ n)) / nt - cosφn$  由 $nsinθ = ntsinφ$ 及三角公式 $sin²θ +cos²θ = 1=> cos²φ = 1 - n²(1-cos²θ)/nt²$  因此可以算出向量: $t = n(d-n(d · n)) / nt - n(1-n²(1-(d·n)²)/nt²)½$

![[计算机图形学/attachments/Pic_065.png]]

观察上述公式当 $n > nt$时根号下部分，可能小于0，此时将不会发生折射，所有光线完全反射即全反射现象。

## 菲涅尔公式与反射率

菲涅尔方程描述了光线经过两个介质界面时，反射和透射(折射)的光照强度比重。如下图所示：

![[计算机图形学/attachments/Pic_066.png]]

直接用上述公式比较复杂，在图形学中我们通常可以用Schlick近似公式计算入射角为$θ$时的反射量：

![[计算机图形学/attachments/Pic_067.png]]

## 比尔-朗伯定律

该定律是光吸收的基本定律，其基本内容是：一束单色光照射入以介质表面，在通过一定厚度的介质后，由于介质吸收了部分光能，透射光的强度就会减弱，其关系为：$A = -log10(It/I0) = log10(1/T) = K *L* C$   其中$A$：吸光度    $I0$：入射光强度  $It$: 透射光强度    $T$： 透射比/透光度  $K$： 吸收系数   $L$:  介质厚度     $C$:  吸光物质浓度    在图形学中我们更关系的是透射率参数T或者透射光强度$It$ 由该公式推导可知： $T = e^-KCL$ 图形学中可能把$KC$作为常数$a$      $It = I0*e^ln(KCL)$

## 绘制透明物体伪代码

由上述的菲涅尔定律和比尔-朗伯定律我们可以在场景中为一些透明介质结算光照，如玻璃，水等。以下是以玻璃为例的伪代码：

![[计算机图形学/attachments/Pic_068.png]]
![[计算机图形学/attachments/Pic_069.png]]

# 光线追踪下的常见效果

## 概述

按照传统的光线追踪的到的图像太过于"整洁"，因为一切都非常清晰，阴影也非常明显，明暗变化也会比较突兀，因此我们需要对传统光线追踪后的图像进行处理，接下来我们会介绍些常见的处理：如反走样，软阴影，DOF等。

## 反走样

回想下之前反走样的原理就是从用不同的滤波器函数对某一点像素进行滤波处理。如使用箱式滤波器，它在每个像素内的$n*n$个像素内采样平均。这种采样方式又称为规则采样，如下：

![[计算机图形学/attachments/Pic_070.png]]

这种方式处理最为简单但是潜在问题是可能出现规则的伪像如摩尔纹。为避免摩尔纹现象可以采用随机采样的方式处理，此方式只需对规则采样稍微增加些随机值即可如下图：

![[计算机图形学/attachments/Pic_071.png]]

## 软阴影

按照之前介绍的阴影计算的方式，某一像素点非黑即白(要么是阴影完全黑色要么不是阴影完全表面颜色)这是因为之前的计算将光源模拟成为一个点，但实际情况中光源是一个体，阴影有本影(全黑)部分也有半影(软阴影)部分如下图：

![[计算机图形学/attachments/Pic_072.png]]

要模拟软阴影一个很自然的想法就是将一个光源模拟为该光源临近矩形内的$N$个光源，计算每个光源的强度为$1/N$，但此方式有两个明显弊端：性能明显下降且阴影到半影过度十分明显。因此我们可以稍微对其做下修改不做N次判定，而是随机从$N$个光源中选择一个进行光照阴影判定，之后使用反走样的方式处理平滑即可。随机选择的方式也很简单，类似三角形与射线碰撞算法，假设光源位置为$c$，矩形两个边分别为$a，b$则随机点 $r = c + ξ1a + ξ2b, ξ1, ξ2$都是$[0.1)$上的随机数，如下图：

![[计算机图形学/attachments/Pic_073.png]]

之后就是随机采样计算如下伪代码：

![[计算机图形学/attachments/Pic_074.png]]

## DOF(景深)

在光线追踪中实现DOF效果与按深度绘制的方法不同，按深度绘制的一般实现方式是通过后处理效果实现的。光照追踪实现时，会设置一个焦平面(对焦到的平面)，将相机的一个点改为一定范围内的随机射线，如下图，对几条随机射线平均求值，可以使得焦平面附近的对象显示清晰其他距离对象模糊的效果。

![[计算机图形学/attachments/Pic_075.png]]

## 光泽反射

某些物体表面如金属表面一定程度上结余理想镜面和漫反射表面之间，有反射图像但是变模糊了。我们可以对理想镜面反射光做个扰动来模拟这一现象。如下图 ，我们可以垂直于反射向量$r$建立$uv$平面在$uv$平面内随机扰动如果我们希望的扰动范围为a(a越大越模糊)则在$u,v$方向的扰动值为 $u = -a/2 + aξ1  v = -a/2 + aξ2$  扰动后的向量 $r′ = r + uu + vv$

![[计算机图形学/attachments/Pic_076.png]]

## 运动模糊

MotionBlur是在非0时间内生成的图像，简单来说既是$T0~T1$时间内的物体叠加。

# 总结

- 本章介绍的几个光学原理非常重要，他们在PBR光照计算中也会使用，他们分别是 菲涅尔定律 菲涅尔公式 比尔-朗伯定律
- 菲涅尔定律说明了入射角与反射角入射角与折射角的关系，入射角等于反射角，入射角的sin值与折射角的sin值之比等于射入介质的反射率与射出介质的反射率之比。
- 菲涅尔公式说明了光线反射量(反射率)与入射角度之间的关系，在图形学中常用Schlick公式近似:  在入射角为θ时的反射率  $R(θ) = R0 + (1 - R0)(1-cosθ)^5$  $R0$为入射方向在法线方向时的反射率 :                       $R0 = ((nt - 1)/(nt+1))²$   $nt$为射入介质的折射率。
- 比尔-朗伯定律反应的是光线射入介质后随着在介质中的传播距离，光照强度被吸收的量。
- 反走样仍然采取箱式滤波器的方式处理，为了避免摩尔纹效应，采样时增加随机值。
- 软阴影的处理方式是将光源加个随机扰动再讲采样扰动后平均处理、
- 景深处理是将相机做个扰动全部射向焦平面在平均处理
- 光泽反射则是将光线在平面的反射向量做个随机扰动处理
- 运动模糊则是在时间线上做平均处理