
---
tags:
  - graphics light illumination global-illumination
---

# 全局光照基本概念

直接我们介绍的所有光照模型和光照模式都是基于入射光直接照射到物体表面的模拟和计算，但在现实世界里，照射到物体表面的光线可能一部分来源于光源的直接照射，另一部分可能来源于经过周围物体多次反射后来到物体表面的光线。而直接照射和间接照射的光源的总和就是全局光照(Global Illumination)简称:GI。如下图:

![[计算机图形学/attachments/Pic_099.png]]

考虑模拟真实世界中在不同物体表面多次反射后进入眼睛的简介光照的模拟问题就称为全局光问题。这里只讲两种最基础(性能也一般)的模拟间接光照的方式：粒子追踪和路径追踪。

# 基于朗伯表面的粒子追踪

## 概述

该方法是对物体自发光和间接照射到物体表面光照的模拟，并不考虑直接照射的光照强度。其基本想法是随机从光源发出一些粒子，并跟随粒子"穿越"整个场景，每次粒子撞击到一个物体表面就会增加其表面的亮度，随着粒子的反射而点亮物体表面知道粒子能量耗尽或者射出场景。

## 推导过程

我们先来回顾下[[12. 光照]]中的基本定义和公式,$BRDF(wi,wo)=Lo/Hi$ ($Lo$为反射方向辐射率，$Hi$为入射方向辐射度),因此$Lo=Hi*BRDF$。辐射度$Hi = Φ/A$ （$Φ$为辐射通量也就是功率，$A$为面积）因此反射方向辐射率$Lo= Φ*BRDF/A$。由于我们考虑的是朗伯表面的间接反射(肯定是漫反射)由[[12. 光照]]中的推导可以知道此时的BRDF方程为$R/π$。因此任意反射方向的辐射度$L=R*Φ/(A*π)$。$R$是半球面反射系数。因此对于每个三角面(面积为A)只要知道其反射系数R，知道其所占的纹理个数$n$则一个辐射通量为$Φ$的光线射中这个三角面所带来的辐射度为$ΔL=nR*Φ/(A*π)$因为辐射率是相对单位面积的，因此$n$个像素需要乘以$n$。为了模拟粒子在传播过程中的衰减,我们需要一个概率$p$来模拟当光线射中表面是发生发射的概率(不反射就表示能量耗尽)。此处的p是个概率不是反射率，因为反射率会根据不同波长而不同也就是说反射率R是三元的$R(rr,gr,br)$。因此当粒子射到表面后的辐射通量变为：$Φo = pRΦi$。接下来只剩最后一个问题，随机反射方向，因此我们模拟的是漫反射因此反射方向应该是随机的。有半球面均匀随机采样可以得出半球面随机方向为: $v = (cos(2πξ1)ξ2½,SIN(2πξ1)ξ2½, (1-ξ2)½,)$  其中$ξ1,ξ2$是随机值.(参考半球面均匀随机采样)

## 粒子追踪光照模拟

由上述原理我们已经有了所需的所有信息，随机反射方向向量$v$,反射概率$p$及反射率$R$,以及反射到三角面后对三角面的光照辐射率增加值：$L = nR*Φ/(A*π)$。为了模拟间接光照中的能量耗损，我们可以设定当反射概率小于表面反射率$R$时，能量被吸收否则能量全部反射。因此使用粒子追踪计算表面简介光照度的方法如下：

![[计算机图形学/attachments/Pic_100.png]]

# 路径追踪

## 概述

路径追踪的方式很简单也很蛮力，即类似关照追踪从每个像素点发出射线，射线在场景中物体表面发生碰撞反射，一直追踪该射线所有发生过碰撞的物体表面如果表面自发光或者本身就是光源则记录其对该像素的光照辐射率。直到射线射中光源或者射出场景抑或是超出最大反射次数。

## 蒙特卡洛积分法

通常计算积分的方式是通过被积分函数计算出原函数，然后对原函数在积分上下限做差求得。(参考3D数学基础)但当有些被积分函数无法求得原函数或者不好计算出原函数时，我们就失去了计算积分的方法。此时就可以用蒙特卡洛积分法，其具体原理是使用一个随机变量对被积分函数进行采样，并将采样值进行一定出了，当采样数很高时，可以得到很好的积分近似值。蒙特卡洛积分如下：

![[计算机图形学/attachments/Pic_101.png]]

## 路径追踪的的辐射率计算

再次回顾下渲染程：         $L(ko) = Le(ko) + ∫BRDF(ki,ko)L(ki)cosθidσi$    如果将后面的积分部分用蒙特卡洛积分代替则有：      $L(ko) ≈ Le(ko) + ∑BRDF(ki,ko)L(ki)cosθidσi / p(ki)$其中$p(x)$是入射方向的概率分布函数。为了简化计算我们将该函数定义为$p(ki)=cosθidσi/π$ 因为在理想漫反射表面的BRDF函数为$R/π$，因此渲染方程就可以简化为：$L(ko) ≈ Le(ko) + ∑RL(ki$) 其中R是反射率。为了简化对$∑RL(ki)$的计算，每个像素只取一个方向参与路径追踪的伪代码如下：

![[计算机图形学/attachments/Pic_102.png]]

此种方式采样可能会有噪点，只能通过不断加大发射射线条数来减少噪点，因此性能较差。

# 仅含表面辐射率的渲染方程

## 概述

回顾下粒子追踪和路径追踪两种方式，其中都需要用到物体表面的辐射率和反射率，根据菲涅尔定律我们知道反射率跟入射角度有关问题较为复杂。因此我们这里需要一个与反射率无关的，金鱼表面辐射度有关的渲染方程。

## 仅与表面辐射率有关的渲染方程

我们先回顾下辐射率的定义，辐射率是通过单位立体角$Δσ$的辐射量(辐射照度)，如下图所以立体角$Δσ$：

![[计算机图形学/attachments/Pic_103.png]]

我们看下立体角随着距离的增加与照射表面面积的关系如下图：

![[计算机图形学/attachments/Pic_104.png]]

  

由此图我们可以得出重要结论：辐射率随着传播距离d的增加照射在物体表面的面积会变为:$A = ΔA*σ*d²$，$ΔA$为单位面积因此$A=σ*d².$
如果将所有到达可见表面的光辐射率都看做从场景中其他表面发射/反射而来，则渲染方程可以写为：

![[计算机图形学/attachments/Pic_105.png]]

如下图所示从另一表面反射的辐射率，此外由重要公式$A=σ*d²$可知$σ=A/d²$。结合图和重要公式可以在渲染方程中将$σ$替换掉，因此公式为：

![[计算机图形学/attachments/Pic_106.png]]
![[计算机图形学/attachments/Pic_107.png]]

# 精准的直接光照

## 概述

全局光照=直接光照+间接光照之前的粒子追踪路径追踪都是针对间接光照的计算，之前的冯氏光照光线追踪是直接光照计算。在此我们将要讲述基于物理世界(光线追踪)的精确直接光照计算方式。

## 精准直接光照基本原理

我们已经得到了表面辐射率的渲染方程：                                                  $L(x,ko)=∫BRDF(ki,ko)L(x1,-ki)v(x,x1)cosθicosθ1dA/|x-x1|²$如下图(推导过程见上一段仅含表面辐射率的渲染方程)：

![[计算机图形学/attachments/Pic_108.png]]

由蒙特卡洛积分法可以将此渲染函数改为以下形式：

$L(x,ko)≈∑BRDF(ki,ko)L(x1,-ki)v(x,x1)cosθicosθ1/p(x1)|x-x1|²$ 其中$p(x)$为从发射平面随机发射光线的概率分布函数。如果去概率分布函数为在发射面均匀分布，
则$p(x) = 1 / A$.  $A$为光线发射平面面积。因此直接光照计算的伪代码如下：

![[计算机图形学/attachments/Pic_109.png]]

此处$d$非单位向量因此 $n.dot(d)= cosθ / |d|$

# 总结

- 全局光照简单来说就是既要考虑直接光照又要考虑间接光照。对于间接光照这里介绍了两种最基本的方法：粒子追踪和路径追踪
- 粒子追踪(既有直接光照又有间接光照)的基本原理是跟随一个光粒子贯穿整个场景，每次与可见表面发生碰撞都会给可见表面增加辐射率。
- 路径追踪是从像素出发反向追踪发光源的过程，每次反射如果表面有自发光都会积累一定量的辐射率。
- 蒙特卡洛积分法是用被积分函数除以概率分布函数做模拟
- 渲染函数可以转化为完全与反射率无关仅跟表面辐射率相关的形式