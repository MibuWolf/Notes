
---
tags:
  - graphics light illumination raytracing 
---

# 光线追踪基本原理

## 概述

在图形学中对场景中对象渲染有两种方式：对象顺序渲染和像素顺序渲染。所谓对象顺序渲染就是之前渲染管线中的方式即: 通过深度缓存区判断每个对象在后台缓冲器的显示区域。像素顺序渲染则是依次从像素出发找到影响该像素的所有对象并计算该像素的值。光线追踪则是用纸像素顺序渲染场景对象的算法。

## 光线追踪基本原理

对场景绘制的本质是相机将每帧"看"到的对象绘制到帧缓冲区。光线追踪的基本做法是对每个像素找到该像素位置"看"到的对象，取得该对象表面信息计算出颜色值。光线追踪的过程基本分为以下三个步骤：

- **生成射线**：根据相机和像素位置确定射线起点和朝向。
- **射线检测**：找到与视线相交的最近的对象。
- **Shading**:  根据射线相交的结果计算像素颜色。

# 生成射线

由数学基础我们可知:  由眼睛e到一点s的射线用方程 $p(t) = e +t(s-e)$  表示。由于要构建由眼睛出发的射线，很自然的我们会想到相机空间，如下图：

![[计算机图形学/attachments/Pic_055.png]]

对于正交投影相机所有光线方向均为$-w$，对于投影相机则需要找到其近截面，假设该平面宽度($u$轴方向)是从$L$到$R(L<0<R)$，高度($v$轴方向)是从$B$到$T(B<0<T)$。假设后台缓冲器(像素)宽高分别为$nx,ny$，则任意像素点$(i,j)$对于到近截面的坐标为：

$u = L + (R-L)(i+0.5)/nx$  // 加0.5是为了映射像素中心
$v =B + (T-B)(j+0.5) / ny$  // 像素块的中心需要加0.5

由以上转换可以计算出每个像素在近截面上的坐标，假设近截面距离原点(眼睛)距离为$d$。如果是正交矩阵，则可以以该点为射线起点，$-w$为射线方向构建射线，如果是投影矩阵则是以原点$e$为射线起点，以$(u,v,-d)$为方向构建射线。如下图：

![[计算机图形学/attachments/Pic_056.png]]

# 射线检测(射线对象相交)

## 概述

由场景图管理空间划分(参见图形学中常用数据结构)在做射线与对象相交测试前，先与空间包围盒(球)检测碰撞，在与对象包围盒(球)检测碰撞，最后在做物体对象表面碰撞检测。

## 射线与三角面碰撞检测

我们假设射线的方程式为： $p(t) = e + td$ ($e$是射线起点，$d$是射线方向，$t$是沿方向的距离)。三角形三个点坐标假设分别为 $a, b, c$。那么射线与该三角形相交的条件如下： $e + td = a + β(b - a) +γ(c - a)$  并且 $β > 0,  γ>0$  并且 $β + γ < 1$。原因如下：

![[计算机图形学/attachments/Pic_057.png]]

由于$a，b，c，e，d$ 都已知并且为三维坐标，变量只有 $t，β，γ$因此由三维一次方程组可以解出 $t，β，γ$ 的值接下来只要判断  $0<t<maxDis and β > 0$, and $γ > 0 and β + γ < 1$即可判定射线与三角面相交($maxDis$表示射线最远检测范围)。

# Shading(像素点颜色计算)

## 概述

当通过射线检测找到射中的物体表面后，就可以根据物体表面信息(如:法线,材质等)计算出该像素最终颜色值。

## Blinn-Phong光照计算像素颜色

当射线检测射中物体表面后，可以从物体表面获取法线信息$n,$光照方向$l$，表面光滑度$p$，光照系数k等信息根据Blin-Phong光照公式可以计算出该点像素颜色

![[计算机图形学/attachments/Pic_058.png]]

如果忘记该光照公式请参见[[11. Phong式光照模型#Blinn-Phong光照模式的改进|Blinn-Phong光照]]。

# 阴影

**阴影判定及绘制**：在光线追踪里判定某物体表面是否在阴影中很简单，无需深度测试这ShadowMap这种复杂的方式，近在表面p向光源方向发出射线，如果射线到达光源前与其他场景对象发生碰撞则说明在阴影中，否则不在阴影中。伪代码如下：

![[计算机图形学/attachments/Pic_059.png]]
![[计算机图形学/attachments/Pic_060.png]]

# 镜面反射

**镜面反射成像**：当从眼睛发出的射线射中的表面是镜面时(由于会发生发射)，实际看到的应该是镜面反射之后的物体表面，因此需要在该表面相对法线反射出一条新的射线进行射线检测。

![[计算机图形学/attachments/Pic_061.png]]

$d$是从眼睛摄像表面的射线，$r$是从镜面反射的射线:
$r = d - 2(d.dot(n))n$ 。在真实世界中反射会损失部分光照强度，因此最终颜色可以用以下公式计算：

![[计算机图形学/attachments/Pic_062.png]]

# 总结

- 光线追踪是另一种确定可见物体表面的方式，它无需使用深度缓存区，仅从每个像素发出射线确定可见物体表面。
- 光线追踪的基本流程是：生成射线，确定可见物体表面信息，绘制像素颜色
- 生成射线是在相机空间，以眼睛为射线起点，屏幕像素映射到近截面的点为射线方向生成射线。
- 射线检测就可以用场景图进行场景分割优化性能，对三角面的射中判定为 $e +dt = a +β(b-a) +γ(c-a)$当 $0 < t < maxDis, β>0, γ >0 ，  β + γ  < 1$时才算射中三角形。
- 判定某像素对应可见表面是否是阴影的方式即从该表面点到光源发出射线，判定如果射中其他物体表面则为阴影区域
- 对可见物体表面为镜面的要继续构建反射射线继续做射线检测算出反射看到的物体表面颜色
- 你会发现整个光线追踪是发生在相机空间，因为光线追踪不需要投影空间(裁剪空间)，投影空间是为了深度测试深度缓冲用的。