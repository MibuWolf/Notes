
---
tags:
  - graphics
---

# 常见数据结构概述

本章将介绍图形学中常见的一些数据结构及处理方法，如：存储网格数据的Mesh，存储管理所有场景对象的场景图，以及用於可见性判断的BSP树等。

# 网格数据

## 概述

图形学中的网格数据是最常见的数据结构，网格通常是由一组三角形组成，三角形数据一般包含有顶点位置，uv以及其他顶点属性信息。此外网格还需要存储的三角形的边等信息。 

## 顶点索引

为了减少数据存储量减少CPU/GPU数据交换的带宽消耗，通常不会简单的将三角形数据存储为三个顶点，而是引入索引的概念，由一个顶点列表和三角形顶点索引确定三角形。这样做主要是为了减少不必要的数据传输带宽消耗，此外除了三角形索引的方式外还有三角形扇三角形带的数据存储方式，也是利用索引较少数据传输的常见方式。

# 场景图

## 概述

场景图的作用是对场景中不同位置的网格数据的管理，使其更高效的被操作提交给GPU渲染。为了高效管理场景中所有网格，场景图一般会对所有网格进行分层管理。

## 包围盒

当场景图按空间划分管理所有场景中对象时，为了提升效率常用包围盒检测代替对真实对象的检测。判断一条射线是否与包围盒相交，按照以下步骤检测即可(此处以2D包围盒为例)：
- 以包围盒四个边构建四条直线: $Xmin Xmax Ymin Ymax$
- 分别计算射线与四条直线的交点：$tXmin  tXmax tYmin  tYmax$
- 如果$tXmin > tYmax$ 或者 $tYmin > tXmax$则表示射线与包围盒没有相交。如下图：

  ![[计算机图形学/attachments/Pic_043.png]]

***注：在以下提到的包围盒都是AABB包围盒。***

## BVH树(层次包围盒)

BVH树又被称为层次包围盒，在光线追踪，物理引擎(射线判断)，场景管理中经常用到，其基本原理是将整个场景用个包围盒包裹，然后依次往下拆分为左右两个小的包围盒各包含一部分场景对象，每个小包围盒再继续细化拆分直到最后只有一个场景对象。整个结构是一个以场景包围盒为根节点的二叉树。当进行射线检测或者可见性判断时遵循以下伪代码：

![[计算机图形学/attachments/Pic_044.png]]

由于二叉树的分配对象方式因此不能保证位置在包围盒内的对象逻辑上一定也在该包围盒内，如下图：

![[计算机图形学/attachments/Pic_045.png]]

***以下所有对包围盒内对象的处理均指的是逻辑上再包围盒内。***

将BVH树的每个节点进行封装伪代码如下：

![[计算机图形学/attachments/Pic_046.png]]

从场景中所有的对象列表构建BVH树为了子树尽量平衡切左右子树尽量少的重叠，常用的方法是沿x轴平分为左右子节点，再讲子节点以y轴平分为孙子节点...直到一个合适的层级。伪代码如下：

![[计算机图形学/attachments/Pic_047.png]]

## 均匀空间细分(Uniform Spatial Subdivision)

在做光线追踪和射线查询时，还有一种常用的空间分割方式就是均匀空间细分，它对空间的划分方式与BVH不同，均匀空间细分是沿坐标轴将场景空间均匀的分割成大小相同的区域。并且同一个对象可能同时存在在不同的均匀空间格子中。每个格子存有当前格子中所有的对象信息。当做射线检测时对所有射线射中的区域内的物体在该格子范围内做射箭检测，查找到第一个射线碰撞到的物体则停止遍历。

![[计算机图形学/attachments/Pic_048.png]]

# BSP树

## 二叉空间分割(Binary Space Partitioning)

二叉空间分割与BVH树类似都是用平面将空间一分为二，但不同的是可能有对象跨越分割平面，此时该对象在平面两侧的子树种都存在。二叉空间分割的节点中，除了左右子树外还存有平面信息。当一条射线射入时，该射线与左右子树只可能有以下四种关系：

![[计算机图形学/attachments/Pic_049.png]]

## BSP树的可见性判定概述

之前讲的BVH树，均匀空间细分，二叉空间分割等方法多用在光线追踪，物理射线查询等，我们同样可以使用类似二叉空间分割的方法另外对可见对象排序得出对场景对象可见性判定的BSP树算法。

## BSP树可见性算法原理

BSP树算法的参考了画家算法，绘制时总是从远到近绘制并且较近的对象会覆盖较远的对象。结合画家算法和二叉空间分割，BSP树算法的本质是根据眼睛，物体对象与分割面的关系确定其绘制的先后顺序。例如：场景内有两个三角形$T1,T2,$眼睛$e$。我们以$T1$三角形所在的面为分割线将空间一分为二，假设$T2$三角形的三个点都在$T1$三角形的同一侧。由平面方程: $p = ax + by +cz +d$  将任意点带入公式可以计算出 $p=0$是在平面上， $p > 0$在平面法线方向，$p<0$则在法线反方向。因此当眼睛$e$与三角形$T2$在$T1$面同侧是先绘制$T1$再绘制$T2$，$e$和$T2$分别在$T1$两侧是则先绘制$T2$在绘制$T1$。如下图：

![[计算机图形学/attachments/Pic_050.png]]

## 构建BSP树

我们先来考虑最简单的情况所有分割平面都完美的将场景对象分割开来，不存在场景对象跨越分割面的情况，此时构建树很简单：

![[计算机图形学/attachments/Pic_051.png]]

但实际应用中不可能这么完美，经常出现一个平面跨越在分割平面两侧，此时我们就需要切割三角形形成新的三角形后再将分割后的三角形组分别加入对应的子树中。如下图：

![[计算机图形学/attachments/Pic_052.png]]

由上图可见我们将三角形由分割平面分成了三个三角形分别是$T1=(a,b,A)$  $T2=(b,B,A)$  $T3=(A,B,c)$，$f(a), f(b), f(c)$分别为三个顶点代入切割平面方程后计算的值(用于判断在切割平面的哪个方向)，因此亏跨越分割平面的三角形分割处理如下：

![[计算机图形学/attachments/Pic_053.png]]
![[计算机图形学/attachments/Pic_054.png]]

***将上边的自然分布在切割平面两侧的对象填充和此处分割三角形后填充逻辑结合在一起就是完整的BSP树的构建过程。***

# 总结

- 介绍了判断直线与包围盒发生碰撞的检测方式：判断直线与包围盒两个x轴直线相交形成的线段与两条y轴执行相交形成的线段有没有相交。
- BVH树的方式对场景切割是分别沿每个轴向将空间一分为二分别建立包围盒(轴线上的对象可以放在任意一边)然后改变轴向在对子空间继续拆分。检测时先与父包围盒检测碰撞再继续与子包围盒检测直到找到第一个射中目标。
- 均匀空间细分法是将空间均分成固定大小的空间(如： 10*10*5米的空间)，每个均匀空间持有所有在此空间内的对象列表。一个场景对象可能存在于多个固定大小空间内。射线检测是先与均匀空间做碰撞，之后在空间内查找射中物体（射中部分一定在此空间内）直到第一个射中场景对象。
- BSP树分割空间用于确定可见对象原理是：使用平面将空间分割，根据对象与眼睛与分割平面的关系(同侧，不同侧)确定可见性及物体渲染顺序，对于跨越平面的对象(三角形)要进行分割处理。