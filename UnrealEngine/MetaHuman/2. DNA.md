---
tags:
  - ue unreal metahuman riglogic DNA
---

# 1. 概述

DNA文件是MetaHuman中非常重要的一个资源配置文件，整个DNA文件中不仅保存了当前角色的基本信息，还保存了控制器与骨骼的绑定关系，基础表情单元(AU)及表情矫正的动作,MorphTarget信息，甚至还有蒙皮，混合形变及纹理动画等相关信息。

DNA相当于美术离线制作的一个效果文件(可以类比想象成一个带模型的动作文件)，而RigLogic的作用则是从DNA数据中采样数据并驱动骨骼，BlendShape(MorphTarget)，材质效果等发生作用。具体来说，运行时通过播放表情动画文件或者Sequencer修复几百根与表情相关的曲线值，RigLogic负责将几百个曲线值整理成一维Float数组作为输入，去DNA数据中查询当前表情的骨骼，BlendShape，动画贴图等数据，并通过调用相应功能接口最终实现表情动画效果。

**注：关于带有几百条曲线的表情动画的制作导出方式，请参见：[MetaHuman文档 | Epic Developer Community (epicgames.com)](https://dev.epicgames.com/documentation/zh-cn/metahuman/metahuman-documentation)**

# 2. DNA数据结构

## 2.1 DNA文件基本结构

在[[RigLogicWhitePaper.pdf]]及官方提供的DNA矫正工具[EpicGames/MetaHuman-DNA-校准 (github.com)](https://github.com/EpicGames/MetaHuman-DNA-Calibration/)文档中都有提及：整个DNA是以二进制格式存储的(利用DNA校准工具可以将其转换成Json方便阅读和理解)。

在结构上DNA中的数据会被分成多个逻辑层，如下图所示：

![[UnrealEngine/MetaHuman/attachments/Pic_069.png]]

## 2.2 DNA校准与Json格式文件

[EpicGames/MetaHuman-DNA-校准 (github.com)](https://github.com/EpicGames/MetaHuman-DNA-Calibration/)是官方提供的修改DNA数据的工具库，它包含了对DNA文件中各种数据的读写操作，并为Maya提供了一些常见的操作DNA的脚本插件。

上文提到，DNA存储的是二进制格式的文件，这并不利于我们深入学习和理解DNA中存储的数据格式。好在官方在[EpicGames/MetaHuman-DNA-校准 (github.com)](https://github.com/EpicGames/MetaHuman-DNA-Calibration/) 中为我们提供了将DNA文件转化成可阅读性更好的Json格式的脚本(DNA校准工具的用法GitHub上有较为详细的使用文档，也有很多视频教程在此不做赘述)。接下来我们将结合转化成Json格式![[Omar.json]]的DNA文件![[Omar.dna]]深入了解其存储数据的格式及运行时的映射方案。

# 3. DNA数据结构分析

上文中我们已经了解到DNA文件的基本层次结构，接下来我们将从代码中数据结构的层面来更加深入的理解DNA中存储了哪些数据，以及在运行时我们是如何使用它们的。

# 3.1 描述层数据

描述层数据主要记录当前DNA的基本信息，包括该DNA文件所属的角色原型，型别，年龄以及LOD坐标系等信息，具体数据结构定义伪代码如下：

``` C++ 伪代码

struct RawDescriptor 
{  
    using StringPair = std::tuple<String<char>, String<char>>;  
  
    String<char> name;              // 名称
    std::uint16_t archetype;        // 原型(在哪个原型基础上改的)
    std::uint16_t gender;           // 型别
    std::uint16_t age;              // 年龄
    Vector<StringPair> metadata;    // 额外的元数据键值对
    std::uint16_t translationUnit;  // 移动单位
    std::uint16_t rotationUnit;     // 旋转单位
    RawCoordinateSystem coordinateSystem;  // 坐标系
    std::uint16_t lodCount;  // LOD数
    std::uint16_t maxLOD;   // 最大LOD
    String<char> complexity;  // 复杂性？
    String<char> dbName;   // 数据库名 ？
    
};

```

该部分数据对应[[Omar.json]]文件中的数据如下图所示：

![[UnrealEngine/MetaHuman/attachments/Pic_070.png]]

描述层数据主要用来描述该DNA资源本身的基本信息，与运行时逻辑并没有太多交集，更多用于定义描述以及与MetaHumanCreator对接等(个人理解)。

# 3.2 定义层数据

如果说描述层数据仅仅是对DNA资源信息的简单描述与功能本身关系不大，那么定义层数据则与运行时逻辑息息相关。在这一层将对DNA控制的所有数据进行定义和说明，简单来说，将会控制那些骨骼，控制器有哪些，BlendShape，贴图动画名分别是什么等等。具体数据结构定义伪代码如下：

``` C++ 伪代码

struct RawDefinition 
{  
    RawLODMapping lodJointMapping;  // 骨骼LOD映射表
    RawLODMapping lodBlendShapeMapping;  // BlendShape LOD映射表
    RawLODMapping lodAnimatedMapMapping;  // 贴图动画LOD映射表
    RawLODMapping lodMeshMapping;  // Mesh LOD映射表
    Vector<String<char> > guiControlNames; // GUI控制器名字列表 
    Vector<String<char> > rawControlNames; // 控制器名字列表
    Vector<String<char> > jointNames;  // 骨骼名列表
    Vector<String<char> > blendShapeChannelNames;  // BlendShape名列表
    Vector<String<char> > animatedMapNames;  // 材质动画名列表
    Vector<String<char> > meshNames;  // mesh名列表
    RawSurjectiveMapping<std::uint16_t> meshBlendShapeChannelMapping;  
    DynArray<std::uint16_t> jointHierarchy;  // 骨骼层级
    RawVector3Vector neutralJointTranslations;  // 原始脸所有骨骼位置信息
    RawVector3Vector neutralJointRotations; // 原始脸所有骨骼旋转信息
};

```

该部分数据对应[[Omar.json]]文件中的数据如下图所示：

![[UnrealEngine/MetaHuman/attachments/Pic_071.png]]

# 3.3 行为层数据

定义层完成了对基本数据的描述，行为层则存储了在各种各种行为(表情)下的骨骼 BlendShape，材质动画等的相关数据。整个行为层数据主要分为四个部分：控制数据，骨骼数据，BlendShape数据和动画贴图数据。由于数据量巨大因此在存储时采用的[[27. 稀疏矩阵行列压缩(Compressed Sparse Row Column Matrix)|稀疏矩阵行压缩(CSR)]]的方式对数据进行存储和组织，这就使得其数据的直观阅读性变的很差，故而该部分也是整个DNA文件中最为复杂的部分。

# 3.3.1 控制数据

